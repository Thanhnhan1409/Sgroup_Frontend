<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .h1 {
            font-size: 30px;
            color: aqua;
        }
    </style>
</head>

<body>
    <div id="app">

    </div>
    <script>
        const AppVue = defineComponent({
            data: {
                msg: "Hello world!",
                color: 'red',
                listHehe: [
                    "heheh"
                ]
            },
            render() {
                return h(
                    "h1", {
                        style: `color: ${this.data.color}`
                    },
                    [
                        h("span","hheeh"),
                        h("div", null,this.data.msg)
                    ]
                )
            }
        })

        function patch(oldVDom, newVDom) {
            const el = oldVDom.$el;
            if (oldVDom.tag === newVDom.tag) {
                // props + children
                const oldProps = oldVDom.props;
                const newProps = newVDom.props;

                newProps && Object.keys(newProps).forEach(key => {
                    const oldValue = oldProps[key];
                    const newValue = newProps[key];

                    if (oldValue !== newValue) {
                        oldVDom.$el.setAttribute(key, newValue);
                    }
                });

                oldProps && Object.keys(oldProps).forEach(key => {
                    if (!(key in newProps)) {
                        oldVDom.removeAttribute(key);
                    }
                });
                const oldChildrend = oldVDom.children;
                const newChildrend = newVDom.children;

                if(typeof newChildrend === 'string' || typeof newChildrend === 'number') {
                    oldVDom.$el.textContent = newChildrend;
                } else if( Array.isArray(newChildrend)) {
                    if( Array.isArray(oldChildrend)) {
                        const commonlength = Math.min(oldChildrend, newChildrend);
                        for (let i =0; i< commonlength; i++) {
                            patch(oldChildrend[i], newChildrend[i])
                        }
                        if(oldChildrend.length < newChildrend.length) {
                            newChildrend.slice(oldChildrend.length).forEach((child) => {
                                mount(child, el);
                                oldChildrend.push(child)
                            })
                        } else if(oldChildrend.length > newChildrend.length) {
                            oldChildrend.slice(newChildrend.length).forEach((child) => {
                                el.removeChild(child.$el)
                                oldChildrend.pop();
                            })
                        }
                    }
                }

            } else {
                // replace completely
                oldVDom.$parent.removeChild(oldVDom.$el);
                // oldVDom.$el = mount(newVDom, oldVDom.$parent).$el; // need to update mount function
            }
        }
        
        function h(tag, props, children) {
            if (typeof props === 'string') {
                children = props
                props = null
            }
            return {
                tag,
                props,
                children
            }
        }

        // // const VNode = h('div', 'hello');

        function propsArray(props, el) {
            if (typeof props.value === 'string') {
                el.setAttribute(props.key, props.value)
            } else if (typeof props.value === 'array') {
                let newValue = ''
                props.value.forEach(item => {
                    if(typeof item === 'string') {
                        newValue += item + ' '
                    }else if (typeof item === 'object') {
                        Object.keys(item).forEach(k => {
                            if(item[k]) {
                                newValue += k + ' '
                            }
                        })
                    }
                })
                el.setAttribute(props.key, newValue)
            } else if (typeof props.value === 'object') {
                let newValue = ''
                Object.keys(props.value).forEach(k => {
                    let v = props.value[k]
                    if(v) {
                        newValue += v + ' '
                    }
                })
                el.setAttribute(props.key, newValue)
            } else if(Array.isArray(props.value)) {
                propsArray({key: 'class', value: props.value}, el)
            }
            return el
        }

        function mount(vnode) {
            const { tag, props, children } = vnode;
            const el = document.createElement(tag);

            if (props) {
                Object.keys(props).forEach((key) => {
                    let value = props[key]

                    if(key.startsWith("on")) {
                        el.addEventListener(key.toLowerCase().replace(/^on/, ""), value)
                    }

                    if (typeof value === 'string') {
                        el.setAttribute(key, value)
                    } 
                    else if (key === 'style') {
                        if (typeof value === 'string') {
                            el.setAttribute(key, value)
                        } else if( typeof value === 'object') {
                            Object.keys(value).forEach((k) => {
                                let val = value[k]
                                el.style[k] = val
                            })
                        }
                    }
                    else if (key === 'class'){
                        // if (typeof value === 'string') {
                        //     el.setAttribute(key, value)
                        // } else if (typeof value === 'array') {
                        //     let newValue = ''
                        //     value.forEach(item => {
                        //         if(typeof item === 'string') {
                        //             newValue += item + ' '
                        //         }else if (typeof item === 'object') {
                        //             Object.keys(item).forEach(k => {
                        //                 if(item[k]) {
                        //                     newValue += k + ' '
                        //                 }
                        //             })
                        //         }
                        //     })
                        //     el.setAttribute(key, newValue)
                        // } else if (typeof value === 'object') {
                        //     let newValue = ''
                        //     Object.keys(value).forEach(k => {
                        //         let v = value[k]
                        //         if(v) {
                        //             newValue += v + ' '
                        //         }
                        //     })
                        //     el.setAttribute(key, newValue)
                        // }
                        propsArray({key: 'class', value: value}, el)
                    }
                })
            }
            if (typeof children === 'string' || typeof children === 'number') {
                el.textContent = children
            } else if (Array.isArray(children)) {
                children.forEach((child) => {
                    if (typeof child === 'string') {
                        el.textContent += child
                    } else {
                        const childEl = mount(child)
                        el.appendChild(childEl)
                    }
                })
            }
            return el;
        }
        
        const VNode = h('div', null, [
        h('p', {
            // style: {
            // color: "red",
            // fontSize: '20px'
            // },
            class: ['h3', 'h2', {'active': 1 > 2}, ['h1']]
        }
        , 'helloworld')
        ])
        
        function createApp(option) {
            let isMounted = false;
            const VNode = null;
            // const VNOde = option.component.render();
            watchEffect(() => {
                if(!isMounted) {
                    VNode = option.component.render();
                    // mount(VNode, document.querySelector(option.id)); // need to update mount function
                    isMounted = true;
                } else {
                    const VNodenew = option.component.render();
                    patch(VNode, VNodenew)
                }
            })
            // const el = mount(option.component)
            // // console.log('hrrrrrr',el)
            // const main = document.querySelector(option.id)
            // // console.log(main, option.id)
            // main.appendChild(el)
        }
        
        createApp({
        id: "#app",
        component: VNode
        })

    </script>
</body>

</html>